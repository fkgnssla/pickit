image: gangintheremark/install-image:latest

stages:
  - build
  - deploy

cache:
  paths:
    - .gradle/wrapper/
    - .gradle/caches/

build_BE:
  stage: build
  script:
    - cd Backend/Core
    - chmod +x ./gradlew
    - ./gradlew clean build -x test
  artifacts:
    paths:
      - Backend/Core/build/libs
  tags:
    - backend
  only:
    - release

deploy_BE:
  stage: deploy
  script:
    - cd Backend/Core
    - sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd /home/ubuntu/PickIt/S11P21A309 && git pull origin release"
    - sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "sudo systemctl stop my-spring-app"
    - sshpass -p "$SSH_PASSWORD" scp build/libs/pickit-0.0.1-SNAPSHOT.jar $SSH_USER@$SSH_HOST:/home/ubuntu/spring-docker/app.jar
    - sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "SPRING_ACTIVE_PROFILE=prod sudo systemctl start my-spring-app"
  tags:
    - backend
  only:
    - release